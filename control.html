<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>Sacramento Tree Foundation Map</title>

<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
<link href='https://api.tiles.mapbox.com/mapbox.js/v1.6.1/mapbox.css' rel='stylesheet' />
<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Rokkitt:400,700" />
<link href='style.css' rel='stylesheet' />

</head>
<body>

<div id='map'></div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script> 
<script src='http://api.tiles.mapbox.com/mapbox.js/v1.6.1/mapbox.js'></script>
<script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-hash/v0.2.1/leaflet-hash.js'></script>
<script src="http://d3js.org/topojson.v1.min.js"></script> 

<script>

  $.getJSON('sactree_zips.json', function(data) {
        // Convert the topojson to geojson
        var zips_geojson = topojson.feature(data, data.objects.zips).features;
        // Create leaflet vector layer and add it to the map
        popup = new L.Popup({
          autoPan: false
        });
        var closeTooltip;

        var Percent_TC = L.geoJson(zips_geojson, {
          style: getStyle1,
          onEachFeature: onEachFeature1
        });

        var mean_bmi = L.geoJson(zips_geojson, {
          style: getStyle2,
          onEachFeature: onEachFeature2
        });

        var per_ovw_ob = L.geoJson(zips_geojson, {
          style: getStyle3,
          onEachFeature: onEachFeature3
        });

        /*var per_ob = L.geoJson(zips_geojson, {
          style: getStyle4,
          onEachFeature: onEachFeature4
        });

        var per_mvpa = L.geoJson(zips_geojson, {
          style: getStyle5,
          onEachFeature: onEachFeature5
        });

        var per_hi_bp = L.geoJson(zips_geojson, {
          style: getStyle6,
          onEachFeature: onEachFeature6
        });

        var per_type2 = L.geoJson(zips_geojson, {
          style: getStyle7,
          onEachFeature: onEachFeature7
        });

        var per_frpr = L.geoJson(zips_geojson, {
          style: getStyle8,
          onEachFeature: onEachFeature8
        });

        var per_asthma = L.geoJson(zips_geojson, {
          style: getStyle9,
          onEachFeature: onEachFeature9
        });*/


        // 1 - Percent_TC
        function getStyle1(feature) {
          return {
            weight: 1, opacity: 0.2, color: 'black', fillOpacity: 0.95, fillColor: getColor1(feature.properties.Percent_TC)
          };
        }
        function getColor1(d) {
          return d > 33 ? '#588125' 
            : d > 23 ? '#729B3F' 
            : d > 15 ? '#8BB458' 
            : d > 9 ? '#A5CE72' 
            : d > 4 ? '#BEE78B' 
            : d > 0.5 ? '#D7FFA4' 
            : '#fff';
        }
        function onEachFeature1(feature, layer) {
          layer.on({
            mousemove: mousemove1, mouseout: mouseout1
          });
        }
        function mousemove1(e) {
          var layer = e.target;
          popup.setLatLng(e.latlng);
          popup.setContent('<h2>' + layer.feature.properties.NAME + ' - ' + layer.feature.properties.ID + '</h2>Tree Cover: <b>' + Math.round(layer.feature.properties.Percent_TC).toFixed(0) + '%</b>');
          if (!popup._map) popup.openOn(map);
          window.clearTimeout(closeTooltip);
            // highlight feature on mouseover
            layer.setStyle({
              weight: 3,
              opacity: 0.3,
              fillOpacity: 0.3
            });
          if (!L.Browser.ie && !L.Browser.opera) {
              layer.bringToFront();
            }
        }
        function mouseout1(e) {
          Percent_TC.resetStyle(e.target);
          closeTooltip = window.setTimeout(function() {
            map.closePopup();
          }, 100);
        }
        // End 1

        // 2 - mean_bmi
        function getStyle2(feature) {
          return {
            weight: 1, opacity: 0.2, color: 'black', fillOpacity: 0.95, fillColor: getColor2(feature.properties.mean_bmi)
          };
        }
        function getColor2(d) {
          return d > 31 ? '#4b75b3' 
              : d > 29 ? '#523494' 
              : d > 27 ? '#99a9c6' 
              : d > 25 ? '#bcc5cf' 
              : d > 22 ? '#dde1d8' 
              : d > 20 ? '#ffffe0' 
              : '#fff';
        }
        function onEachFeature2(feature, layer) {
          layer.on({
            mousemove: mousemove2, mouseout: mouseout2
          });
        }
        function mousemove2(e) {
          var layer = e.target;
          popup.setLatLng(e.latlng);
          popup.setContent('<h2>' + layer.feature.properties.NAME + ' - ' + layer.feature.properties.ID + '</h2>Mean BMI: <b>' + Math.round(layer.feature.properties.mean_bmi).toFixed(0) + '</b>');
          if (!popup._map) popup.openOn(map);
          window.clearTimeout(closeTooltip);
            // highlight feature on mouseover
            layer.setStyle({
              weight: 3,
              opacity: 0.3,
              fillOpacity: 0.3
            });
          if (!L.Browser.ie && !L.Browser.opera) {
              layer.bringToFront();
            }
        }
        function mouseout2(e) {
          mean_bmi.resetStyle(e.target);
          closeTooltip = window.setTimeout(function() {
            map.closePopup();
          }, 100);
        }
        // End 2

        // 3 - per_ovw_ob
        function getStyle3(feature) {
          return {
            weight: 1, opacity: 0.2, color: 'black', fillOpacity: 0.95, fillColor: getColor3(feature.properties.per_ovw_ob)
          };
        }
        function getColor3(d) {
          return d > 0.7 ? '#4b75b3' 
              : d > 0.5 ? '#523494' 
              : d > 0.4 ? '#99a9c6' 
              : d > 0.25 ? '#bcc5cf' 
              : d > 0.1 ? '#dde1d8' 
              : d > 0.02 ? '#ffffe0' 
              : '#fff';
        }
        function onEachFeature3(feature, layer) {
          layer.on({
            mousemove: mousemove3, mouseout: mouseout3
          });
        }
        function mousemove3(e) {
          var layer = e.target;
          popup.setContent('<h2>' + layer.feature.properties.NAME + ' - ' + layer.feature.properties.ID + '</h2>Overweight & Obese: <b>' + Math.round(layer.feature.properties.per_ovw_ob * 100).toFixed(0) + '%</b>');
          if (!popup._map) popup.openOn(map);
          window.clearTimeout(closeTooltip);
            // highlight feature on mouseover
            layer.setStyle({
              weight: 3,
              opacity: 0.3,
              fillOpacity: 0.3
            });
          if (!L.Browser.ie && !L.Browser.opera) {
              layer.bringToFront();
            }
        }
        function mouseout3(e) {
          per_ovw_ob.resetStyle(e.target);
          closeTooltip = window.setTimeout(function() {
            map.closePopup();
          }, 100);
        }
        // End 3

//////////MAP DEF //////////////////
        map = L.map("map", {
            zoom: 10,
            center: [38.574, -121.384],
            layers: [Percent_TC, mean_bmi, per_ovw_ob/*, per_ob, per_mvpa, per_hi_bp, per_type2, per_frpr, per_asthma*/]
        });

        var baseLayer = new L.mapbox.tileLayer('landplanner.map-khn9uycz').addTo(map);

        // ADD THE REFERENCE OVERLAY
        var topPane = map._createPane('leaflet-top-pane', map.getPanes().mapPane);
        var topLayer = new L.mapbox.tileLayer('sactree.h7id69df', {
          maxZoom: 17,
          opacity: 0.4
        }).addTo(map);
        topPane.appendChild(topLayer.getContainer());
        topLayer.setZIndex(7);

        // Larger screens get expanded layer control
        if (document.body.clientWidth <= 767) {
            var isCollapsed = true;
        } else {
            var isCollapsed = false;
        };

        var baseLayers = {
            "% Treecover": Percent_TC, 
            "Mean BMI": mean_bmi, 
            "% Overweight/Obese": per_ovw_ob/*, 
            "% Obese": per_ob, 
            "% w/ >150min MVPA/wk": per_mvpa, 
            "% w/ High Blood Pressure": per_hi_bp, 
            "% w/ Type 2 Diabetes": per_type2, 
            "% in Fair/Poor Health": per_frpr, 
            "% w/ Asthma": per_asthma*/
        };

        var layerControl = L.control.layers(baseLayers, {
            collapsed: isCollapsed
        }).addTo(map);

      });

</script>
</body>
</html>